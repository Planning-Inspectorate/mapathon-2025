{% extends "layouts/main.njk" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="row my-4">
  <div class="col-lg-3 mb-3">
    <aside class="" style="background:#e6e6e6; border-radius:8px; border:1px solid #b1b4b6; padding:32px 24px; font-family:'GDS Transport',Arial,sans-serif;">
      <h2 style="font-size:2rem; font-weight:700; color:#00703c; margin-bottom:1rem;">About this map</h2>
      <p style="font-size:1.125rem; color:#505a5f; margin-bottom:1.5rem;">This interactive map shows major infrastructure projects across the UK, sourced from the National Infrastructure Consenting Portal.</p>
      <h3 style="font-size:1.25rem; font-weight:600; color:#00703c; margin-bottom:0.75rem;">How to use</h3>
      <ul style="font-size:1.125rem; color:#505a5f; margin-bottom:1.5rem; padding-left:1.2em;">
        <li style="margin-bottom:0.5em;">Zoom and pan to explore different regions.</li>
        <li style="margin-bottom:0.5em;">Click clusters to expand and see individual projects.</li>
        <li style="margin-bottom:0.5em;">Hover over pins to view project details.</li>
        <li style="margin-bottom:0.5em;">Click "Project details" for more information.</li>
      </ul>
      <div style="background:#f3f2f1; color:#505a5f; border-left:4px solid #00703c; padding:1em; font-size:1.125rem;">Tip: Use the map to discover projects near you or in areas of interest.</div>
    </aside>
  </div>
  <div class="col-lg-9">
    <div class="card" style="border:1px solid #b1b4b6; font-family:'GDS Transport',Arial,sans-serif;">
      <div class="card-header" style="background:#00703c; color:#fff; font-weight:500; font-size:1.5rem; padding:1rem 1.5rem;">UK Infrastructure Projects Map</div>
      <div class="card-body p-0" style="height:87vh; background:#fff;">
        <div id="os-map" style="height:100%; width:100%;"></div>
      </div>
      <div class="card-footer text-muted" style="background:#f3f2f1; color:#505a5f; font-size:1rem; padding:0.75rem 1.5rem;">Data from National Infrastructure Consenting Portal</div>
    </div>
  </div>
</div>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" crossorigin=""/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/govuk-frontend@4.7.0/govuk-frontend.min.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" crossorigin=""></script>
<script>
  const map = L.map('os-map', {
    center: [54.5, -3],
    zoom: 7,
    minZoom: 5,
    maxZoom: 12,
    attributionControl: false
  });
  L.tileLayer('/api/map-tile/{z}/{x}/{y}', { maxZoom: 12, tileSize: 256 }).addTo(map);

  const projects = {{ projects | dump | safe }};
  const markers = L.markerClusterGroup({
    maxClusterRadius: 40 // Reduce cluster radius for tighter clusters
  });
  projects.forEach(p => {
    const popupContent = `
      <div style="font-size:1.15rem; line-height:1.5;">
        <strong style="font-size:1.3rem;">${p.name}</strong><br>
        <span>Status: <b>${p.status}</b></span><br>
        <span>${p.description}</span><br>
        <a href="${p.link}" target="_blank">Project details</a>
      </div>
    `;
    const marker = L.marker([p.lat, p.lng]);
    marker.bindPopup(popupContent, { closeButton: true });
    marker.on('mouseover', function(e) {
      if (!marker.isPopupOpen()) marker.openPopup();
    });
    marker.on('mouseout', function(e) {
      // Only close popup if not hovering over the popup itself
      setTimeout(() => {
        const popup = document.querySelector('.leaflet-popup:hover');
        if (!popup) marker.closePopup();
      }, 200);
    });
    markers.addLayer(marker);
  });
  map.addLayer(markers);
  markers.on('clusterclick', function (a) {
    a.layer.spiderfy();
  });
</script>
{% endblock %}